#!/usr/bin/env bash
# CONSTANTS
DOCKERIZED_ROOT=$(dirname "$BASH_SOURCE")/..
DOCKERIZED_COMPOSE_FILE="${DOCKERIZED_ROOT}/docker-compose.yml"
DOCKERIZED_BINARY="${DOCKERIZED_ROOT}/build/dockerized"

# region COMPILE DOCKERIZED
DOCKERIZED_COMPILE=
if [ "$1" == "--compile" ]; then
  DOCKERIZED_COMPILE=1
  shift
fi

case "$OSTYPE" in
msys | cygwin | linux-gnu)
  GOOS=windows
  DOCKERIZED_BINARY="${DOCKERIZED_BINARY}.exe"
  ;;
# Operating systems below not tested. Logic based on:
#  - https://github.com/dylanaraps/neofetch/issues/433
#  - https://gist.github.com/asukakenji/f15ba7e588ac42795f421b48b8aede63
openbsd*)
  GOOS=openbsd
  ;;
freebsd*)
  GOOS=freebsd
  ;;
darwin*)
  GOOS=darwin
  ;;
netbsd*)
  GOOS=netbsd
  ;;
solaris*)
  GOOS=solaris
  ;;
# default
*)
  GOOS=linux
  ;;
esac

case "$(uname -m)" in
x86_64)
  GOARCH=amd64
  ;;
i*86)
  GOARCH=386
  ;;

esac



if [ $DOCKERIZED_COMPILE ] || [ ! -f "$DOCKERIZED_BINARY" ]; then
  echo "Compiling dockerized..." >/dev/stderr

  if which docker-compose >/dev/null 2>&1; then
    echo "running docker-compose..." >/dev/stderr
    docker-compose \
      -f "$DOCKERIZED_COMPOSE_FILE" \
      run --rm \
      -e "GOOS=$GOOS" \
      _compile
  else
    echo "running docker compose..." >/dev/stderr
    docker compose \
      run \
      -f "$DOCKERIZED_COMPOSE_FILE" \
      --rm \
      -e "GOOS=$GOOS" \
      _compile
  fi

  if [ $? -ne 0 ]; then
    echo "Failed to compile dockerized" >/dev/stderr
    exit 1
  fi

  if [ $# -eq 0 ]; then
    echo "Compiled dockerized" >/dev/stderr
    exit 0
  fi
fi
# endregion

# RUN DOCKERIZED:
"$DOCKERIZED_BINARY" "$@"
